@using PhishingGame.Blazor.States
@using Radzen.Blazor
@using Radzen
@using PhishingGame.Core.Models
@using PhishingGame.Core;
@using System.Linq

@inherits GameViewBase<FirstRoundState>
@inject NavigationManager NavigationManager

<RadzenDataGrid TItem="Email"
                Data="@Data"
                RowSelect="OnRowSelect"
                SelectionMode="DataGridSelectionMode.Single"
                AllowPaging="true"
                AllowSorting="true"
                PageSize="8"
                Class="rz-hoverable"
                Style="cursor:pointer; width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">

    <Columns>
        <RadzenDataGridColumn TItem="Email" Property="Sender" Title="Afzender" />
        <RadzenDataGridColumn TItem="Email" Property="Subject" Title="Onderwerp" />
        <RadzenDataGridColumn TItem="Email" Title="Phishing?">
            <Template Context="email">
                <RadzenButton Click="@(() => OnMailFlagged(email))">
                    <RadzenIcon Icon="flag" IconColor="@GetIconColor(email)" />
                </RadzenButton>
            </Template>
        </RadzenDataGridColumn>
>
    </Columns>
</RadzenDataGrid>

@code {

    public IEnumerable<Email> Data { get; set; } = Enumerable.Empty<Email>();

    public List<Email> Flagged { get; set; } = new();

    protected override void OnParametersSet()
    {
           if (State.FlaggedMails.TryGetValue(Team, out var flaggedGuids) && Session.SessionData.Mails.TryGetValue(Team, out var emails))
        {
            Flagged = emails.Where(e => flaggedGuids.Contains(e.Id)).ToList();
        }
        else
        {
            Flagged = new List<Email>();
        }

        Data = Session.SessionData.Mails.TryGetValue(Team, out var data) ? data : Enumerable.Empty<Email>();

        State.EmailFlagged -= UpdateFlaggedMails;
        State.EmailFlagged += UpdateFlaggedMails;
    }

    void OnRowSelect(Email email) => NavigationManager.NavigateTo($"/email/{email.Id}");

    private void OnMailFlagged(Email email)
    {
        if (Flagged.Contains(email))
        {
            Flagged.Remove(email);
        }

        else Flagged.Add(email);

        State.NotifyEmailFlagged(Team, email);
    }

    private async void UpdateFlaggedMails(Team team, Email email)
    {
        if (team == null || !team.Equals(Team)) return;

        await InvokeAsync(StateHasChanged);
    }

    private string GetIconColor(Email email)
        => Flagged.Contains(email) ? "red" : "green";

    public void Dispose()
    {
        State.EmailFlagged -= UpdateFlaggedMails;
    }
}