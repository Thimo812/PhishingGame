@using Core.Models;
@using PhishingGame.Blazor.States
@using PhishingGame.Core
@using Radzen
@using Radzen.Blazor

@inherits GameViewBase<EmailCompositionState>

@inject NavigationManager Navigator

<RadzenButton Text="Nieuwe e-mail" Icon="add_circle" Click="AddEmail" Style="margin-bottom: 10px;" />

<RadzenDataGrid TItem="Email"
                Data="@Data"
                RowSelect="OnRowSelect"
                SelectionMode="DataGridSelectionMode.Single"
                AllowPaging="true"
                AllowSorting="true"
                PageSize="8"
                Class="rz-hoverable"
                Style="cursor:pointer; width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">

    <Columns>
        <RadzenDataGridColumn TItem="Email" Property="Sender" Title="Afzender" />
        <RadzenDataGridColumn TItem="Email" Property="Subject" Title="Onderwerp" />
        <RadzenDataGridColumn TItem="Email" Title="Phishing?" Width="75px">
            <Template Context="email">
                <RadzenIcon Icon="flag" IconColor="@GetIconColor(email)" />
            </Template>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>

@code {
    public List<Email> Data { get; set; } = default!;

    protected override void OnParametersSet()
    {
        State.EmailsUpdated += OnEmailsUpdated;

        Data = Session.SessionData.Mails.TryGetValue(Team, out var data) ? data : new List<Email>();
    }

    private void OnRowSelect(Email email)
    {
        Navigator.NavigateTo($"/session/{Session.SessionId}/mail/{email.Id}");
    }

    private void AddEmail()
    {
        Navigator.NavigateTo($"/session/{Session.SessionId}/addmail");
    }

    private string GetIconColor(Email email)
        => email.IsPhishing ? "red" : "green";

    private async void OnEmailsUpdated(Team team, List<Email> mails)
    {
        if (!Team.Equals(team)) return;

        await InvokeAsync(StateHasChanged);
    }
}