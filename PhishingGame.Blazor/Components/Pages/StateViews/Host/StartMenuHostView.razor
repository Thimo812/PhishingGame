@using PhishingGame.Core.Exceptions
@using Radzen.Blazor;
@using Radzen;
@using PhishingGame.Blazor.States;
@using PhishingGame.Core;
@inherits GameViewBase<StartMenuState>
@inject NavigationManager Navigator
@inject DialogService DialogService

<RadzenRow>
    <RadzenColumn Size="8">
        <RadzenPanel>
            <HeaderTemplate>
                <RadzenText TextStyle="TextStyle.H3" TextAlign="TextAlign.Center">Spelers</RadzenText>
            </HeaderTemplate>
            <ChildContent>
                <RadzenCard Variant="Variant.Outlined">
                    <RadzenDataList WrapItems="true" TItem="Player" Data="@Session.SessionData.Players"  
                                    style="grid-template-columns: repeat(3, 1fr); display: grid; gap: 1rem;">
                        <Template Context="player">
                            <RadzenCard Variant="Variant.Filled" Style="width: 100%">
                                <RadzenText TextStyle="TextStyle.Body1">@player.Name</RadzenText>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                </RadzenCard>
            </ChildContent>
        </RadzenPanel>
    </RadzenColumn>
    <RadzenColumn Size="4">
        <RadzenQRCode Value="@State.BuildUrl()" />
    </RadzenColumn>
</RadzenRow>
<RadzenFooter Style="display: flex; justify-content: flex-end; gap: 1rem">
    <RadzenButton ButtonStyle="ButtonStyle.Primary" Click="@State.StopSession">Stop</RadzenButton>
    <RadzenButton ButtonStyle="ButtonStyle.Secondary" Click="StartSessionAsync">Start sessie</RadzenButton>
</RadzenFooter>

@code {
    protected override void OnParametersSet()
    {
        if (Session == null) return;
        Session.PlayerJoined += async session => await InvokeAsync(StateHasChanged);
    }

    private async Task StartSessionAsync()
    {
        try
        {
            await Session.NextStateAsync();
        }
        catch(InvalidPlayerCountException)
        {
            await DialogService.Alert("Wacht totdat er tenminste twee spelers aanwezig zijn", "Game kan niet gestart worden", new() { CloseDialogOnOverlayClick = true });
        }
    }
}

