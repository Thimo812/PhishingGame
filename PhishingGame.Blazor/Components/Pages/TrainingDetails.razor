@page "/training/{id:guid}"

@using PhishingGame.Core.Models
@using Radzen;
@using Radzen.Blazor
@using Microsoft.EntityFrameworkCore

@inject NotificationService NotificationService
@inject PhishingGame.Data.PhishingDbContext Db
@inject DialogService DialogService
@inject NavigationManager NavigationManager

@if (training == null)
{
    <p>training niet gevonden.</p>

}
else
{

    <div style="padding:20px">

        <h4 style="color:#006699; border-bottom:2px solid #ccc; padding-bottom:5px;">@training.Name</h4>
        <h3 style="margin-top:10px; color:#222;">E-mails in deze training:</h3>

        @if (training.Emails == null || !training.Emails.Any())
        {
            <p>Geen e-mails gekoppeld aan deze training.</p>
        }
        else
        {
            <RadzenDataGrid TItem="Email"
                            Data="@training.Emails"
                            RowSelect="OnRowSelect"
                            SelectionMode="DataGridSelectionMode.Single"
                            AllowPaging="true"
                            AllowSorting="true"
                            PageSize="8"
                            Class="rz-hoverable"
                            Style="cursor:pointer; width:100%; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">

                            <Columns>

                    <RadzenDataGridColumn TItem="Email" Property="Sender" Title="Afzender" />

                    <RadzenDataGridColumn TItem="Email" Property="Subject" Title="Onderwerp" />

                    <RadzenDataGridColumn TItem="Email" Title="Phishing?">
                        <Template Context="email">
                            @if (email.IsPhishing)
                            {
                                <RadzenIcon Icon="flag" Style="color:red;" />
                            }
                            else
                            {
                                <RadzenIcon Icon="flag" Style="color:green;" />
                            }
                        </Template>
                    </RadzenDataGridColumn>

                    <RadzenDataGridColumn TItem="Email" Title="Acties">
                        <Template Context="email">
                            <RadzenButton Icon="delete"
                                          ButtonStyle="ButtonStyle.Danger"
                                          Size="ButtonSize.Small"
                                          Click="@(args => Delete(email))"
                                          @onclick:stopPropagation="true" />
                        </Template>
                    </RadzenDataGridColumn>
            
                </Columns>
            </RadzenDataGrid>
        }
    

        <div style="margin-top:15px;">
            <RadzenButton Text="Sluiten"
                          Icon="close"
                          Style="margin-right:5px;"
                          Click="@ClosePage" />

        </div>
    </div>
}


@code {
    [Parameter] public Training Training { get; set; } = default!;
    [Parameter] public Guid id { get; set; }
    private Training? training;

    async protected override Task OnInitializedAsync()
    {
        training = await Db.Trainings.
        Include(t => t.Emails).
        FirstOrDefaultAsync(e => e.Id == id);
    }

    void OnRowSelect(Email email) => NavigationManager.NavigateTo($"/email/{email.Id}");

    async Task Delete(Email email)
    {
        if (training == null) return;
        var confirm = await DialogService.Confirm("Weet u zeker dat u deze e-mail wilt verwijderen?", "Bevestigen.");
        if (confirm == true)
        {
            training.Emails.Remove(email);
            await Db.SaveChangesAsync();
        }
    }
    void ClosePage() => NavigationManager.NavigateTo("/trainingoverview");

}


